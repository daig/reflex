<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#runQueryT"><span class="hs-identifier hs-var">runQueryT</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#mapQuery"><span class="hs-identifier hs-var">mapQuery</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#mapQueryResult"><span class="hs-identifier hs-var">mapQueryResult</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#dynWithQueryT"><span class="hs-identifier hs-var">dynWithQueryT</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#withQueryT"><span class="hs-identifier hs-var">withQueryT</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Fix</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Reader</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Ref</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Align</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Dependent</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DMap</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DSum</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Dependent</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DMap</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span class="hs-operator">.</span><span class="hs-identifier">Compose</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Functor.Misc.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span class="hs-operator">.</span><span class="hs-identifier">Misc</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Some</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Some</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Some</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">These</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.EventWriter.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">EventWriter</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.Host.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Host</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.PerformEvent.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">PerformEvent</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.PostBuild.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">PostBuild</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.Query.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.Requester.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Requester</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Reflex.TriggerEvent.Class.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">TriggerEvent</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Reflex.Patch.MapWithMove.html"><span class="hs-identifier">Reflex</span><span class="hs-operator">.</span><span class="hs-identifier">Patch</span><span class="hs-operator">.</span><span class="hs-identifier">MapWithMove</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MapWithMove</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">newtype</span><span> </span><a name="QueryT"><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier">QueryT</span></a></a><span> </span><a name="local-6989586621679571613"><a href="#local-6989586621679571613"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679571614"><a href="#local-6989586621679571614"><span class="hs-identifier">q</span></a></a><span> </span><a name="local-6989586621679571615"><a href="#local-6989586621679571615"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679571616"><a href="#local-6989586621679571616"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="QueryT"><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier">QueryT</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unQueryT"><a href="Reflex.Query.Base.html#unQueryT"><span class="hs-identifier">unQueryT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571613"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571614"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Reflex.EventWriter.html#EventWriterT"><span class="hs-identifier hs-type">EventWriterT</span></a><span> </span><a href="#local-6989586621679571613"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571614"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a><span> </span><a href="#local-6989586621679571613"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571614"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571615"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571616"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#MonadHold"><span class="hs-identifier hs-type">MonadHold</span></a><span> </span><a href="#local-6989586621679571613"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#MonadSample"><span class="hs-identifier hs-type">MonadSample</span></a><span> </span><a href="#local-6989586621679571613"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadAtomicRef</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-identifier">runQueryT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFix</span><span> </span><a href="#local-6989586621679571637"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571638"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571638"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#Reflex"><span class="hs-identifier hs-type">Reflex</span></a><span> </span><a href="#local-6989586621679571639"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571639"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571638"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571637"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679571640"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Class.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a><span> </span><a href="#local-6989586621679571639"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571638"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571637"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571640"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#Incremental"><span class="hs-identifier hs-type">Incremental</span></a><span> </span><a href="#local-6989586621679571639"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-type">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571638"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><a name="runQueryT"><a href="Reflex.Query.Base.html#runQueryT"><span class="hs-identifier">runQueryT</span></a></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><a name="local-6989586621679571641"><a href="#local-6989586621679571641"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679571642"><a href="#local-6989586621679571642"><span class="hs-identifier">qr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679571643"><a href="#local-6989586621679571643"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571644"><a href="#local-6989586621679571644"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679571645"><a href="#local-6989586621679571645"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><a href="Reflex.EventWriter.html#runEventWriterT"><span class="hs-identifier hs-var">runEventWriterT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">runStateT</span><span> </span><a href="#local-6989586621679571641"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571642"><span class="hs-identifier hs-var">qr</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571643"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldlM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679571646"><a href="#local-6989586621679571646"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679571647"><a href="#local-6989586621679571647"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571646"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><a href="#local-6989586621679571647"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><a href="#local-6989586621679571644"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571645"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">newtype</span><span> </span><a name="QueryTLoweredResult"><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier">QueryTLoweredResult</span></a></a><span> </span><a name="local-6989586621679571610"><a href="#local-6989586621679571610"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679571611"><a href="#local-6989586621679571611"><span class="hs-identifier">q</span></a></a><span> </span><a name="local-6989586621679571612"><a href="#local-6989586621679571612"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="QueryTLoweredResult"><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier">QueryTLoweredResult</span></a></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571612"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571610"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571611"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">getQueryTLoweredResultValue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-type">QueryTLoweredResult</span></a><span> </span><a href="#local-6989586621679571634"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571635"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571636"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571636"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-58"></a><a name="getQueryTLoweredResultValue"><a href="Reflex.Query.Base.html#getQueryTLoweredResultValue"><span class="hs-identifier">getQueryTLoweredResultValue</span></a></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-var">QueryTLoweredResult</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679571648"><a href="#local-6989586621679571648"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679571648"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-identifier">getQueryTLoweredResultWritten</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-type">QueryTLoweredResult</span></a><span> </span><a href="#local-6989586621679571631"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571632"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571633"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571631"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571632"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-61"></a><a name="getQueryTLoweredResultWritten"><a href="Reflex.Query.Base.html#getQueryTLoweredResultWritten"><span class="hs-identifier">getQueryTLoweredResultWritten</span></a></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-var">QueryTLoweredResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679571649"><a href="#local-6989586621679571649"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679571649"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#Reflex"><span class="hs-identifier hs-type">Reflex</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFix</span><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Class.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#MonadHold"><span class="hs-identifier hs-type">MonadHold</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#MonadAdjust"><span class="hs-identifier hs-type">MonadAdjust</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Class.html#MonadAdjust"><span class="hs-identifier hs-type">MonadAdjust</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>  </span><a name="local-8214565720324001193"><a href="Reflex.Class.html#runWithReplace"><span class="hs-identifier">runWithReplace</span></a></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><a name="local-6989586621679571725"><a href="#local-6989586621679571725"><span class="hs-identifier">a0</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679571726"><a href="#local-6989586621679571726"><span class="hs-identifier">a'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679571727"><a href="#local-6989586621679571727"><span class="hs-identifier">r0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571728"><a href="#local-6989586621679571728"><span class="hs-identifier">bs0</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679571729"><a href="#local-6989586621679571729"><span class="hs-identifier">r'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#runWithReplace"><span class="hs-identifier hs-var">runWithReplace</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">runStateT</span><span> </span><a href="#local-6989586621679571725"><span class="hs-identifier hs-var">a0</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unQueryT</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571726"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-66"></a><span>    </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-67"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">sampleBs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571733"><a href="#local-6989586621679571733"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Reflex.Class.html#MonadSample"><span class="hs-identifier hs-type">MonadSample</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571733"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571733"><span class="hs-identifier hs-type">m'</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-68"></a><span>          </span><a name="local-6989586621679571730"><a href="#local-6989586621679571730"><span class="hs-identifier">sampleBs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679571734"><a href="#local-6989586621679571734"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679571735"><a href="#local-6989586621679571735"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571734"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><a href="#local-6989586621679571735"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-69"></a><span>          </span><a name="local-6989586621679571731"><a href="#local-6989586621679571731"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571729"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-70"></a><span>          </span><a name="local-6989586621679571732"><a href="#local-6989586621679571732"><span class="hs-identifier">patches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571730"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571728"><span class="hs-identifier hs-var">bs0</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-71"></a><span>            </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Reflex.Class.html#pushCheap"><span class="hs-identifier hs-var">pushCheap</span></a><span> </span><a href="#local-6989586621679571731"><span class="hs-identifier hs-var">bs'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679571736"><a href="#local-6989586621679571736"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-72"></a><span>              </span><a name="local-6989586621679571737"><a href="#local-6989586621679571737"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#~~"><span class="hs-operator hs-var">~~</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571730"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571736"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571732"><span class="hs-identifier hs-var">patches</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571737"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679571732"><span class="hs-identifier hs-var">patches</span></a><span>
</span><a name="line-75"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571727"><span class="hs-identifier hs-var">r0</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679571729"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-identifier">traverseDMapWithKeyWithAdjust</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679571717"><a href="#local-6989586621679571717"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator hs-type">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator hs-type">*</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679571718"><a href="#local-6989586621679571718"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679571719"><a href="#local-6989586621679571719"><span class="hs-identifier">v'</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DMap</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">GCompare</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571720"><a href="#local-6989586621679571720"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571720"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571718"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679571720"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571719"><span class="hs-identifier hs-type">v'</span></a><span> </span><a href="#local-6989586621679571720"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DMap</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571718"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.DMap.html#PatchDMap"><span class="hs-identifier hs-type">PatchDMap</span></a><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571718"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DMap</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571719"><span class="hs-identifier hs-type">v'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.DMap.html#PatchDMap"><span class="hs-identifier hs-type">PatchDMap</span></a><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571719"><span class="hs-identifier hs-type">v'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>  </span><a name="local-8214565720324001194"><a href="Reflex.Class.html#traverseDMapWithKeyWithAdjust"><span class="hs-identifier">traverseDMapWithKeyWithAdjust</span></a></a><span> </span><a name="local-6989586621679571738"><a href="#local-6989586621679571738"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679571739"><a href="#local-6989586621679571739"><span class="hs-identifier">dm0</span></a></a><span> </span><a name="local-6989586621679571740"><a href="#local-6989586621679571740"><span class="hs-identifier">dm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">f'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571742"><a href="#local-6989586621679571742"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571742"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571718"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679571742"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.EventWriter.html#EventWriterT"><span class="hs-identifier hs-type">EventWriterT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Compose</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-type">QueryTLoweredResult</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571719"><span class="hs-identifier hs-type">v'</span></a><span> </span><a href="#local-6989586621679571742"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>        </span><a name="local-6989586621679571741"><a href="#local-6989586621679571741"><span class="hs-identifier">f'</span></a></a><span> </span><a name="local-6989586621679571743"><a href="#local-6989586621679571743"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679571744"><a href="#local-6989586621679571744"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Compose</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-var">QueryTLoweredResult</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unQueryT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571738"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679571743"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679571744"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679571745"><a href="#local-6989586621679571745"><span class="hs-identifier">result0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571746"><a href="#local-6989586621679571746"><span class="hs-identifier">result'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#traverseDMapWithKeyWithAdjust"><span class="hs-identifier hs-var">traverseDMapWithKeyWithAdjust</span></a><span> </span><a href="#local-6989586621679571741"><span class="hs-identifier hs-var">f'</span></a><span> </span><a href="#local-6989586621679571739"><span class="hs-identifier hs-var">dm0</span></a><span> </span><a href="#local-6989586621679571740"><span class="hs-identifier hs-var">dm'</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679571747"><a href="#local-6989586621679571747"><span class="hs-identifier">liftedResult0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Misc.html#mapKeyValuePairsMonotonic"><span class="hs-identifier hs-var">mapKeyValuePairsMonotonic</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571755"><a href="#local-6989586621679571755"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><span class="hs-identifier hs-var">Compose</span><span> </span><a name="local-6989586621679571756"><a href="#local-6989586621679571756"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571755"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><a href="Reflex.Query.Base.html#getQueryTLoweredResultValue"><span class="hs-identifier hs-var">getQueryTLoweredResultValue</span></a><span> </span><a href="#local-6989586621679571756"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571745"><span class="hs-identifier hs-var">result0</span></a><span>
</span><a name="line-82"></a><span>        </span><a name="local-6989586621679571748"><a href="#local-6989586621679571748"><span class="hs-identifier">liftedResult'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#fforCheap"><span class="hs-identifier hs-var">fforCheap</span></a><span> </span><a href="#local-6989586621679571746"><span class="hs-identifier hs-var">result'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Reflex.Patch.DMap.html#PatchDMap"><span class="hs-identifier hs-var">PatchDMap</span></a><span> </span><a name="local-6989586621679571757"><a href="#local-6989586621679571757"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.DMap.html#PatchDMap"><span class="hs-identifier hs-var">PatchDMap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-83"></a><span>          </span><a href="Data.Functor.Misc.html#mapKeyValuePairsMonotonic"><span class="hs-identifier hs-var">mapKeyValuePairsMonotonic</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571758"><a href="#local-6989586621679571758"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><a href="Data.Functor.Misc.html#ComposeMaybe"><span class="hs-identifier hs-var">ComposeMaybe</span></a><span> </span><a name="local-6989586621679571759"><a href="#local-6989586621679571759"><span class="hs-identifier">mr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571758"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><a href="Data.Functor.Misc.html#ComposeMaybe"><span class="hs-identifier hs-var">ComposeMaybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#getQueryTLoweredResultValue"><span class="hs-identifier hs-var">getQueryTLoweredResultValue</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getCompose</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571759"><span class="hs-identifier hs-var">mr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571757"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-84"></a><span>        </span><span class="hs-identifier">liftedBs0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-85"></a><span>        </span><a name="local-6989586621679571749"><a href="#local-6989586621679571749"><span class="hs-identifier">liftedBs0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromDistinctAscList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571760"><a href="#local-6989586621679571760"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><span class="hs-identifier hs-var">Compose</span><span> </span><a name="local-6989586621679571761"><a href="#local-6989586621679571761"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Some</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">This</span><span> </span><a href="#local-6989586621679571760"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#getQueryTLoweredResultWritten"><span class="hs-identifier hs-var">getQueryTLoweredResultWritten</span></a><span> </span><a href="#local-6989586621679571761"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">DMap</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679571745"><span class="hs-identifier hs-var">result0</span></a><span>
</span><a name="line-86"></a><span>        </span><span class="hs-identifier">liftedBs'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.Map.html#PatchMap"><span class="hs-identifier hs-type">PatchMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>        </span><a name="local-6989586621679571750"><a href="#local-6989586621679571750"><span class="hs-identifier">liftedBs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#fforCheap"><span class="hs-identifier hs-var">fforCheap</span></a><span> </span><a href="#local-6989586621679571746"><span class="hs-identifier hs-var">result'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Reflex.Patch.DMap.html#PatchDMap"><span class="hs-identifier hs-var">PatchDMap</span></a><span> </span><a name="local-6989586621679571762"><a href="#local-6989586621679571762"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.Map.html#PatchMap"><span class="hs-identifier hs-var">PatchMap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-88"></a><span>          </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromDistinctAscList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571763"><a href="#local-6989586621679571763"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><a href="Data.Functor.Misc.html#ComposeMaybe"><span class="hs-identifier hs-var">ComposeMaybe</span></a><span> </span><a name="local-6989586621679571764"><a href="#local-6989586621679571764"><span class="hs-identifier">mr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Some</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">This</span><span> </span><a href="#local-6989586621679571763"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#getQueryTLoweredResultWritten"><span class="hs-identifier hs-var">getQueryTLoweredResultWritten</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getCompose</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571764"><span class="hs-identifier hs-var">mr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">DMap</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679571762"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-identifier">sampleBs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571753"><a href="#local-6989586621679571753"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Reflex.Class.html#MonadSample"><span class="hs-identifier hs-type">MonadSample</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571753"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571753"><span class="hs-identifier hs-type">m'</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-90"></a><span>        </span><a name="local-6989586621679571751"><a href="#local-6989586621679571751"><span class="hs-identifier">sampleBs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679571765"><a href="#local-6989586621679571765"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679571766"><a href="#local-6989586621679571766"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571765"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><a href="#local-6989586621679571766"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-identifier">accumBehaviors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571754"><a href="#local-6989586621679571754"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Reflex.Class.html#MonadHold"><span class="hs-identifier hs-type">MonadHold</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571754"><span class="hs-identifier hs-type">m'</span></a><span>
</span><a name="line-92"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-93"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.Map.html#PatchMap"><span class="hs-identifier hs-type">PatchMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-94"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571754"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571717"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-type">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">-- f accumulates the child behavior state we receive from running traverseDMapWithKeyWithAdjust for the underlying monad.</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- When an update occurs, it also computes a patch to communicate to the parent QueryT state.</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">-- bs0 is a Map denoting the behaviors of the current children.</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- pbs is a PatchMap denoting an update to the behaviors of the current children</span><span>
</span><a name="line-100"></a><span>        </span><a name="local-6989586621679571752"><a href="#local-6989586621679571752"><span class="hs-identifier">accumBehaviors</span></a></a><span> </span><a name="local-6989586621679571767"><a href="#local-6989586621679571767"><span class="hs-identifier">bs0</span></a></a><span> </span><a name="local-6989586621679571768"><a href="#local-6989586621679571768"><span class="hs-identifier">pbs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Reflex.Patch.Map.html#PatchMap"><span class="hs-identifier hs-var">PatchMap</span></a><span> </span><a name="local-6989586621679571769"><a href="#local-6989586621679571769"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679571770"><a href="#local-6989586621679571770"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679571771"><a href="#local-6989586621679571771"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679571772"><a href="#local-6989586621679571772"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679571771"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679571767"><span class="hs-identifier hs-var">bs0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-102"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679571772"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-103"></a><span>                  </span><span class="hs-comment">-- If the update is to delete the state for a child that doesn't exist, the patch is mempty.</span><span>
</span><a name="line-104"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-105"></a><span>                  </span><span class="hs-comment">-- If the update is to update the state for a child that doesn't exist, the patch is the sample of the new state.</span><span>
</span><a name="line-106"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571773"><a href="#local-6989586621679571773"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571751"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571773"><span class="hs-identifier hs-var">newBs</span></a><span>
</span><a name="line-107"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571774"><a href="#local-6989586621679571774"><span class="hs-identifier">oldBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679571772"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-108"></a><span>                  </span><span class="hs-comment">-- If the update is to delete the state for a child that already exists, the patch is the negation of the child's current state</span><span>
</span><a name="line-109"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.html#negateG"><span class="hs-identifier hs-var">negateG</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571751"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571774"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-110"></a><span>                  </span><span class="hs-comment">-- If the update is to update the state for a child that already exists, the patch is the negation of sampling the child's current state</span><span>
</span><a name="line-111"></a><span>                  </span><span class="hs-comment">-- composed with the sampling the child's new state.</span><span>
</span><a name="line-112"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571775"><a href="#local-6989586621679571775"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#~~"><span class="hs-operator hs-var">~~</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571751"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571775"><span class="hs-identifier hs-var">newBs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679571751"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571774"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-113"></a><span>          </span><span class="hs-comment">-- we compute the patch by iterating over the update PatchMap and proceeding by cases. Then we fold over the</span><span>
</span><a name="line-114"></a><span>          </span><span class="hs-comment">-- child patches and wrap them in AdditivePatch.</span><span>
</span><a name="line-115"></a><span>          </span><a name="local-6989586621679571776"><a href="#local-6989586621679571776"><span class="hs-identifier">patch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fold</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">traverseWithKey</span><span> </span><a href="#local-6989586621679571770"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679571769"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-116"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.Class.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679571768"><span class="hs-identifier hs-var">pbs</span></a><span> </span><a href="#local-6989586621679571767"><span class="hs-identifier hs-var">bs0</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679571776"><span class="hs-identifier hs-var">patch</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679571777"><a href="#local-6989586621679571777"><span class="hs-identifier">qpatch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-type">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#mapAccumMaybeM_"><span class="hs-identifier hs-var">mapAccumMaybeM_</span></a><span> </span><a href="#local-6989586621679571752"><span class="hs-identifier hs-var">accumBehaviors</span></a><span> </span><a href="#local-6989586621679571749"><span class="hs-identifier hs-var">liftedBs0</span></a><span> </span><a href="#local-6989586621679571750"><span class="hs-identifier hs-var">liftedBs'</span></a><span>
</span><a name="line-118"></a><span>    </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fold</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679571751"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571749"><span class="hs-identifier hs-var">liftedBs0</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571777"><span class="hs-identifier hs-var">qpatch</span></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571747"><span class="hs-identifier hs-var">liftedResult0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679571748"><span class="hs-identifier hs-var">liftedResult'</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-identifier">traverseDMapWithKeyWithAdjustWithMove</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679571721"><a href="#local-6989586621679571721"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator hs-type">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator hs-type">*</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679571722"><a href="#local-6989586621679571722"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679571723"><a href="#local-6989586621679571723"><span class="hs-identifier">v'</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DMap</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">GCompare</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571724"><a href="#local-6989586621679571724"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571724"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571722"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679571724"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571723"><span class="hs-identifier hs-type">v'</span></a><span> </span><a href="#local-6989586621679571724"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DMap</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571722"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.DMapWithMove.html#PatchDMapWithMove"><span class="hs-identifier hs-type">PatchDMapWithMove</span></a><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571722"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DMap</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571723"><span class="hs-identifier hs-type">v'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.DMapWithMove.html#PatchDMapWithMove"><span class="hs-identifier hs-type">PatchDMapWithMove</span></a><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571723"><span class="hs-identifier hs-type">v'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>  </span><a name="local-8214565720324001195"><a href="Reflex.Class.html#traverseDMapWithKeyWithAdjustWithMove"><span class="hs-identifier">traverseDMapWithKeyWithAdjustWithMove</span></a></a><span> </span><a name="local-6989586621679571778"><a href="#local-6989586621679571778"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679571779"><a href="#local-6989586621679571779"><span class="hs-identifier">dm0</span></a></a><span> </span><a name="local-6989586621679571780"><a href="#local-6989586621679571780"><span class="hs-identifier">dm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">f'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571782"><a href="#local-6989586621679571782"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679571782"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571722"><span class="hs-identifier hs-type">v</span></a><span> </span><a href="#local-6989586621679571782"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.EventWriter.html#EventWriterT"><span class="hs-identifier hs-type">EventWriterT</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571715"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Compose</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-type">QueryTLoweredResult</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571723"><span class="hs-identifier hs-type">v'</span></a><span> </span><a href="#local-6989586621679571782"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>        </span><a name="local-6989586621679571781"><a href="#local-6989586621679571781"><span class="hs-identifier">f'</span></a></a><span> </span><a name="local-6989586621679571783"><a href="#local-6989586621679571783"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679571784"><a href="#local-6989586621679571784"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Compose</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.Query.Base.html#QueryTLoweredResult"><span class="hs-identifier hs-var">QueryTLoweredResult</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unQueryT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571778"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679571783"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679571784"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679571785"><a href="#local-6989586621679571785"><span class="hs-identifier">result0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571786"><a href="#local-6989586621679571786"><span class="hs-identifier">result'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#traverseDMapWithKeyWithAdjustWithMove"><span class="hs-identifier hs-var">traverseDMapWithKeyWithAdjustWithMove</span></a><span> </span><a href="#local-6989586621679571781"><span class="hs-identifier hs-var">f'</span></a><span> </span><a href="#local-6989586621679571779"><span class="hs-identifier hs-var">dm0</span></a><span> </span><a href="#local-6989586621679571780"><span class="hs-identifier hs-var">dm'</span></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679571787"><a href="#local-6989586621679571787"><span class="hs-identifier">liftedResult0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Functor.Misc.html#mapKeyValuePairsMonotonic"><span class="hs-identifier hs-var">mapKeyValuePairsMonotonic</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571795"><a href="#local-6989586621679571795"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><span class="hs-identifier hs-var">Compose</span><span> </span><a name="local-6989586621679571796"><a href="#local-6989586621679571796"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571795"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><a href="Reflex.Query.Base.html#getQueryTLoweredResultValue"><span class="hs-identifier hs-var">getQueryTLoweredResultValue</span></a><span> </span><a href="#local-6989586621679571796"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571785"><span class="hs-identifier hs-var">result0</span></a><span>
</span><a name="line-126"></a><span>        </span><a name="local-6989586621679571788"><a href="#local-6989586621679571788"><span class="hs-identifier">liftedResult'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#fforCheap"><span class="hs-identifier hs-var">fforCheap</span></a><span> </span><a href="#local-6989586621679571786"><span class="hs-identifier hs-var">result'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Patch.DMapWithMove.html#mapPatchDMapWithMove"><span class="hs-identifier hs-var">mapPatchDMapWithMove</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#getQueryTLoweredResultValue"><span class="hs-identifier hs-var">getQueryTLoweredResultValue</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getCompose</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>        </span><span class="hs-identifier">liftedBs0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-128"></a><span>        </span><a name="local-6989586621679571789"><a href="#local-6989586621679571789"><span class="hs-identifier">liftedBs0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromDistinctAscList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679571797"><a href="#local-6989586621679571797"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=&gt;</span><span> </span><span class="hs-identifier hs-var">Compose</span><span> </span><a name="local-6989586621679571798"><a href="#local-6989586621679571798"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Some</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">This</span><span> </span><a href="#local-6989586621679571797"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Base.html#getQueryTLoweredResultWritten"><span class="hs-identifier hs-var">getQueryTLoweredResultWritten</span></a><span> </span><a href="#local-6989586621679571798"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">DMap</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679571785"><span class="hs-identifier hs-var">result0</span></a><span>
</span><a name="line-129"></a><span>        </span><span class="hs-identifier">liftedBs'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.MapWithMove.html#PatchMapWithMove"><span class="hs-identifier hs-type">PatchMapWithMove</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>        </span><a name="local-6989586621679571790"><a href="#local-6989586621679571790"><span class="hs-identifier">liftedBs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Class.html#fforCheap"><span class="hs-identifier hs-var">fforCheap</span></a><span> </span><a href="#local-6989586621679571786"><span class="hs-identifier hs-var">result'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Patch.DMapWithMove.html#weakenPatchDMapWithMoveWith"><span class="hs-identifier hs-var">weakenPatchDMapWithMoveWith</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#getQueryTLoweredResultWritten"><span class="hs-identifier hs-var">getQueryTLoweredResultWritten</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getCompose</span><span class="hs-special">)</span><span> </span><span class="hs-comment">{- \(PatchDMap p) -&gt; PatchMapWithMove $
          Map.fromDistinctAscList $ (\(k :=&gt; mr) -&gt; (Some.This k, fmap (fmap (getQueryTLoweredResultWritten . getCompose)) mr)) &lt;$&gt; DMap.toList p -}</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-identifier">sampleBs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571793"><a href="#local-6989586621679571793"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Reflex.Class.html#MonadSample"><span class="hs-identifier hs-type">MonadSample</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571793"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571793"><span class="hs-identifier hs-type">m'</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-133"></a><span>        </span><a name="local-6989586621679571791"><a href="#local-6989586621679571791"><span class="hs-identifier">sampleBs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679571799"><a href="#local-6989586621679571799"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679571800"><a href="#local-6989586621679571800"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571799"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><a href="#local-6989586621679571800"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-identifier">accumBehaviors'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679571794"><a href="#local-6989586621679571794"><span class="hs-identifier">m'</span></a></a><span class="hs-operator">.</span><span> </span><a href="Reflex.Class.html#MonadHold"><span class="hs-identifier hs-type">MonadHold</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571794"><span class="hs-identifier hs-type">m'</span></a><span>
</span><a name="line-135"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-136"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.MapWithMove.html#PatchMapWithMove"><span class="hs-identifier hs-type">PatchMapWithMove</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span>
</span><a name="line-137"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571794"><span class="hs-identifier hs-type">m'</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><a href="#local-6989586621679571721"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Reflex.Class.html#Behavior"><span class="hs-identifier hs-type">Behavior</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-type">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-comment">-- f accumulates the child behavior state we receive from running traverseDMapWithKeyWithAdjustWithMove for the underlying monad.</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-comment">-- When an update occurs, it also computes a patch to communicate to the parent QueryT state.</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-comment">-- bs0 is a Map denoting the behaviors of the current children.</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-comment">-- pbs is a PatchMapWithMove denoting an update to the behaviors of the current children</span><span>
</span><a name="line-143"></a><span>        </span><a name="local-6989586621679571792"><a href="#local-6989586621679571792"><span class="hs-identifier">accumBehaviors'</span></a></a><span> </span><a name="local-6989586621679571801"><a href="#local-6989586621679571801"><span class="hs-identifier">bs0</span></a></a><span> </span><a name="local-6989586621679571802"><a href="#local-6989586621679571802"><span class="hs-identifier">pbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-144"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679571803"><a href="#local-6989586621679571803"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Patch.MapWithMove.html#unPatchMapWithMove"><span class="hs-identifier hs-var">unPatchMapWithMove</span></a><span> </span><a href="#local-6989586621679571802"><span class="hs-identifier hs-var">pbs</span></a><span>
</span><a name="line-145"></a><span>              </span><a name="local-6989586621679571804"><a href="#local-6989586621679571804"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679571805"><a href="#local-6989586621679571805"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679571806"><a href="#local-6989586621679571806"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679571805"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679571801"><span class="hs-identifier hs-var">bs0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-146"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">MapWithMove</span><span class="hs-operator">.</span><span class="hs-identifier">_nodeInfo_from</span><span> </span><a href="#local-6989586621679571806"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-147"></a><span>                  </span><span class="hs-comment">-- If the update is to delete the state for a child that doesn't exist, the patch is mempty.</span><span>
</span><a name="line-148"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Delete"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Delete</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-149"></a><span>                  </span><span class="hs-comment">-- If the update is to update the state for a child that doesn't exist, the patch is the sample of the new state.</span><span>
</span><a name="line-150"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Insert"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Insert</span></a><span> </span><a name="local-6989586621679571807"><a href="#local-6989586621679571807"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571807"><span class="hs-identifier hs-var">newBs</span></a><span>
</span><a name="line-151"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Move"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Move</span></a><span> </span><a name="local-6989586621679571808"><a href="#local-6989586621679571808"><span class="hs-identifier">k'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679571808"><span class="hs-identifier hs-var">k'</span></a><span> </span><a href="#local-6989586621679571801"><span class="hs-identifier hs-var">bs0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-152"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-153"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571809"><a href="#local-6989586621679571809"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571809"><span class="hs-identifier hs-var">newBs</span></a><span>
</span><a name="line-154"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571810"><a href="#local-6989586621679571810"><span class="hs-identifier">oldBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">MapWithMove</span><span class="hs-operator">.</span><span class="hs-identifier">_nodeInfo_from</span><span> </span><a href="#local-6989586621679571806"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-155"></a><span>                  </span><span class="hs-comment">-- If the update is to delete the state for a child that already exists, the patch is the negation of the child's current state</span><span>
</span><a name="line-156"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Delete"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Delete</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.html#negateG"><span class="hs-identifier hs-var">negateG</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571810"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-157"></a><span>                  </span><span class="hs-comment">-- If the update is to update the state for a child that already exists, the patch is the negation of sampling the child's current state</span><span>
</span><a name="line-158"></a><span>                  </span><span class="hs-comment">-- composed with the sampling the child's new state.</span><span>
</span><a name="line-159"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Insert"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Insert</span></a><span> </span><a name="local-6989586621679571811"><a href="#local-6989586621679571811"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#~~"><span class="hs-operator hs-var">~~</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571811"><span class="hs-identifier hs-var">newBs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571810"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-160"></a><span>                  </span><a href="Reflex.Patch.MapWithMove.html#From_Move"><span class="hs-identifier hs-var">MapWithMove</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">From_Move</span></a><span> </span><a name="local-6989586621679571812"><a href="#local-6989586621679571812"><span class="hs-identifier">k'</span></a></a><span>
</span><a name="line-161"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679571812"><span class="hs-identifier hs-var">k'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679571805"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-162"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679571812"><span class="hs-identifier hs-var">k'</span></a><span> </span><a href="#local-6989586621679571801"><span class="hs-identifier hs-var">bs0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-163"></a><span>                  </span><span class="hs-comment">-- If we are moving from a non-existent key, that is a delete</span><span>
</span><a name="line-164"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Patch.html#negateG"><span class="hs-identifier hs-var">negateG</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571810"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-165"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679571813"><a href="#local-6989586621679571813"><span class="hs-identifier">newBs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#~~"><span class="hs-operator hs-var">~~</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571813"><span class="hs-identifier hs-var">newBs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571810"><span class="hs-identifier hs-var">oldBs</span></a><span>
</span><a name="line-166"></a><span>          </span><span class="hs-comment">-- we compute the patch by iterating over the update PatchMap and proceeding by cases. Then we fold over the</span><span>
</span><a name="line-167"></a><span>          </span><span class="hs-comment">-- child patches and wrap them in AdditivePatch.</span><span>
</span><a name="line-168"></a><span>          </span><a name="local-6989586621679571814"><a href="#local-6989586621679571814"><span class="hs-identifier">patch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fold</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">traverseWithKey</span><span> </span><a href="#local-6989586621679571804"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679571803"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-169"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.Class.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679571802"><span class="hs-identifier hs-var">pbs</span></a><span> </span><a href="#local-6989586621679571801"><span class="hs-identifier hs-var">bs0</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679571814"><span class="hs-identifier hs-var">patch</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679571815"><a href="#local-6989586621679571815"><span class="hs-identifier">qpatch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Class.html#Event"><span class="hs-identifier hs-type">Event</span></a><span> </span><a href="#local-6989586621679571714"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-type">AdditivePatch</span></a><span> </span><a href="#local-6989586621679571716"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#mapAccumMaybeM_"><span class="hs-identifier hs-var">mapAccumMaybeM_</span></a><span> </span><a href="#local-6989586621679571792"><span class="hs-identifier hs-var">accumBehaviors'</span></a><span> </span><a href="#local-6989586621679571789"><span class="hs-identifier hs-var">liftedBs0</span></a><span> </span><a href="#local-6989586621679571790"><span class="hs-identifier hs-var">liftedBs'</span></a><span>
</span><a name="line-171"></a><span>    </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fold</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679571791"><span class="hs-identifier hs-var">sampleBs</span></a><span> </span><a href="#local-6989586621679571789"><span class="hs-identifier hs-var">liftedBs0</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571815"><span class="hs-identifier hs-var">qpatch</span></a><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571787"><span class="hs-identifier hs-var">liftedResult0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679571788"><span class="hs-identifier hs-var">liftedResult'</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadTrans</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571712"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571713"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>  </span><a name="local-8214565720323796696"><span class="hs-identifier">lift</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.PostBuild.Class.html#PostBuild"><span class="hs-identifier hs-type">PostBuild</span></a><span> </span><a href="#local-6989586621679571709"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571710"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.PostBuild.Class.html#PostBuild"><span class="hs-identifier hs-type">PostBuild</span></a><span> </span><a href="#local-6989586621679571709"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571709"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571711"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571710"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-178"></a><span>  </span><a name="local-8214565720324218512"><a href="Reflex.PostBuild.Class.html#getPostBuild"><span class="hs-identifier">getPostBuild</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Reflex.PostBuild.Class.html#getPostBuild"><span class="hs-identifier hs-var">getPostBuild</span></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadAsyncException</span><span> </span><a href="#local-6989586621679571704"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadAsyncException</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571705"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571706"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571704"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-181"></a><span>  </span><a name="local-8214565720323796444"><span class="hs-identifier">mask</span></a><span> </span><a name="local-6989586621679571707"><a href="#local-6989586621679571707"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679571708"><a href="#local-6989586621679571708"><span class="hs-identifier">unMask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unQueryT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571707"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679571708"><span class="hs-identifier hs-var">unMask</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unQueryT</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.TriggerEvent.Class.html#TriggerEvent"><span class="hs-identifier hs-type">TriggerEvent</span></a><span> </span><a href="#local-6989586621679571701"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571702"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.TriggerEvent.Class.html#TriggerEvent"><span class="hs-identifier hs-type">TriggerEvent</span></a><span> </span><a href="#local-6989586621679571701"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571701"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571703"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571702"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-184"></a><span>  </span><a name="local-8214565720324253313"><a href="Reflex.TriggerEvent.Class.html#newTriggerEvent"><span class="hs-identifier">newTriggerEvent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Reflex.TriggerEvent.Class.html#newTriggerEvent"><span class="hs-identifier hs-var">newTriggerEvent</span></a><span>
</span><a name="line-185"></a><span>  </span><a name="local-8214565720324253314"><a href="Reflex.TriggerEvent.Class.html#newTriggerEventWithOnComplete"><span class="hs-identifier">newTriggerEventWithOnComplete</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Reflex.TriggerEvent.Class.html#newTriggerEventWithOnComplete"><span class="hs-identifier hs-var">newTriggerEventWithOnComplete</span></a><span>
</span><a name="line-186"></a><span>  </span><a name="local-8214565720324253315"><a href="Reflex.TriggerEvent.Class.html#newEventWithLazyTriggerWithOnComplete"><span class="hs-identifier">newEventWithLazyTriggerWithOnComplete</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.TriggerEvent.Class.html#newEventWithLazyTriggerWithOnComplete"><span class="hs-identifier hs-var">newEventWithLazyTriggerWithOnComplete</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.PerformEvent.Class.html#PerformEvent"><span class="hs-identifier hs-type">PerformEvent</span></a><span> </span><a href="#local-6989586621679571698"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571699"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.PerformEvent.Class.html#PerformEvent"><span class="hs-identifier hs-type">PerformEvent</span></a><span> </span><a href="#local-6989586621679571698"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571698"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571700"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571699"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Performable</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571698"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571700"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571699"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.PerformEvent.Class.html#Performable"><span class="hs-identifier hs-type">Performable</span></a><span> </span><a href="#local-6989586621679571699"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-190"></a><span>  </span><a name="local-8214565720324254297"><a href="Reflex.PerformEvent.Class.html#performEvent_"><span class="hs-identifier">performEvent_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.PerformEvent.Class.html#performEvent_"><span class="hs-identifier hs-var">performEvent_</span></a><span>
</span><a name="line-191"></a><span>  </span><a name="local-8214565720324254296"><a href="Reflex.PerformEvent.Class.html#performEvent"><span class="hs-identifier">performEvent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.PerformEvent.Class.html#performEvent"><span class="hs-identifier hs-var">performEvent</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadRef</span><span> </span><a href="#local-6989586621679571694"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadRef</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571695"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571696"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571694"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Ref</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571695"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571696"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571694"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Ref</span><span> </span><a href="#local-6989586621679571694"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-195"></a><span>  </span><a name="local-8214565720323807846"><span class="hs-identifier">newRef</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">newRef</span><span>
</span><a name="line-196"></a><span>  </span><a name="local-8214565720323807845"><span class="hs-identifier">readRef</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readRef</span><span>
</span><a name="line-197"></a><span>  </span><a name="local-8214565720323807844"><span class="hs-identifier">writeRef</span></a><span> </span><a name="local-6989586621679571697"><a href="#local-6989586621679571697"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">writeRef</span><span> </span><a href="#local-6989586621679571697"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.Host.Class.html#MonadReflexCreateTrigger"><span class="hs-identifier hs-type">MonadReflexCreateTrigger</span></a><span> </span><a href="#local-6989586621679571690"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571691"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Host.Class.html#MonadReflexCreateTrigger"><span class="hs-identifier hs-type">MonadReflexCreateTrigger</span></a><span> </span><a href="#local-6989586621679571690"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571690"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571692"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571691"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-200"></a><span>  </span><a name="local-8214565720324180503"><a href="Reflex.Host.Class.html#newEventWithTrigger"><span class="hs-identifier">newEventWithTrigger</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.Host.Class.html#newEventWithTrigger"><span class="hs-identifier hs-var">newEventWithTrigger</span></a><span>
</span><a name="line-201"></a><span>  </span><a name="local-8214565720324180504"><a href="Reflex.Host.Class.html#newFanEventWithTrigger"><span class="hs-identifier">newFanEventWithTrigger</span></a></a><span> </span><a name="local-6989586621679571693"><a href="#local-6989586621679571693"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Host.Class.html#newFanEventWithTrigger"><span class="hs-identifier hs-var">newFanEventWithTrigger</span></a><span> </span><a href="#local-6989586621679571693"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-identifier">mapQuery</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Query.Class.html#QueryMorphism"><span class="hs-identifier hs-type">QueryMorphism</span></a><span> </span><a href="#local-6989586621679571629"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571630"><span class="hs-identifier hs-type">q'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571629"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679571630"><span class="hs-identifier hs-type">q'</span></a><span>
</span><a name="line-204"></a><a name="mapQuery"><a href="Reflex.Query.Base.html#mapQuery"><span class="hs-identifier">mapQuery</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_queryMorphism_mapQuery</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">mapQueryResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reflex.Query.Class.html#QueryMorphism"><span class="hs-identifier hs-type">QueryMorphism</span></a><span> </span><a href="#local-6989586621679571627"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571628"><span class="hs-identifier hs-type">q'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571628"><span class="hs-identifier hs-type">q'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Class.html#QueryResult"><span class="hs-identifier hs-type">QueryResult</span></a><span> </span><a href="#local-6989586621679571627"><span class="hs-identifier hs-type">q</span></a><span>
</span><a name="line-207"></a><a name="mapQueryResult"><a href="Reflex.Query.Base.html#mapQueryResult"><span class="hs-identifier">mapQueryResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_queryMorphism_mapQueryResult</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">-- | withQueryT's QueryMorphism argument needs to be a group homomorphism in order to behave correctly</span><span>
</span><a name="line-210"></a><span class="hs-identifier">withQueryT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFix</span><span> </span><a href="#local-6989586621679571622"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.PostBuild.Class.html#PostBuild"><span class="hs-identifier hs-type">PostBuild</span></a><span> </span><a href="#local-6989586621679571623"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571622"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571624"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571625"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571624"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571625"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Class.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><a href="#local-6989586621679571625"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Query.Class.html#QueryMorphism"><span class="hs-identifier hs-type">QueryMorphism</span></a><span> </span><a href="#local-6989586621679571624"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571625"><span class="hs-identifier hs-type">q'</span></a><span>
</span><a name="line-212"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571623"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571624"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571622"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679571626"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-213"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571623"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571625"><span class="hs-identifier hs-type">q'</span></a><span> </span><a href="#local-6989586621679571622"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679571626"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-214"></a><a name="withQueryT"><a href="Reflex.Query.Base.html#withQueryT"><span class="hs-identifier">withQueryT</span></a></a><span> </span><a name="local-6989586621679571650"><a href="#local-6989586621679571650"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679571651"><a href="#local-6989586621679571651"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-215"></a><span>  </span><a name="local-6989586621679571652"><a href="#local-6989586621679571652"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Class.html#askQueryResult"><span class="hs-identifier hs-var">askQueryResult</span></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679571653"><a href="#local-6989586621679571653"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571654"><a href="#local-6989586621679571654"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Query.Base.html#runQueryT"><span class="hs-identifier hs-var">runQueryT</span></a><span> </span><a href="#local-6989586621679571651"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Query.Base.html#mapQueryResult"><span class="hs-identifier hs-var">mapQueryResult</span></a><span> </span><a href="#local-6989586621679571650"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679571652"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-217"></a><span>  </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#mapQuery"><span class="hs-identifier hs-var">mapQuery</span></a><span> </span><a href="#local-6989586621679571650"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571654"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>    </span><span class="hs-special">(</span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.Query.Base.html#mapQuery"><span class="hs-identifier hs-var">mapQuery</span></a><span> </span><a href="#local-6989586621679571650"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unAdditivePatch</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#updatedIncremental"><span class="hs-identifier hs-var">updatedIncremental</span></a><span> </span><a href="#local-6989586621679571654"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679571653"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- | dynWithQueryT's (Dynamic t QueryMorphism) argument needs to be a group homomorphism at all times in order to behave correctly</span><span>
</span><a name="line-223"></a><span class="hs-identifier">dynWithQueryT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFix</span><span> </span><a href="#local-6989586621679571617"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.PostBuild.Class.html#PostBuild"><span class="hs-identifier hs-type">PostBuild</span></a><span> </span><a href="#local-6989586621679571618"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571617"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571619"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571619"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571620"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571620"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Class.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><a href="#local-6989586621679571620"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Class.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a><span> </span><a href="#local-6989586621679571618"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Class.html#QueryMorphism"><span class="hs-identifier hs-type">QueryMorphism</span></a><span> </span><a href="#local-6989586621679571619"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571620"><span class="hs-identifier hs-type">q'</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571618"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571619"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571617"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679571621"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-226"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571618"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571620"><span class="hs-identifier hs-type">q'</span></a><span> </span><a href="#local-6989586621679571617"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679571621"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-227"></a><a name="dynWithQueryT"><a href="Reflex.Query.Base.html#dynWithQueryT"><span class="hs-identifier">dynWithQueryT</span></a></a><span> </span><a name="local-6989586621679571655"><a href="#local-6989586621679571655"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679571656"><a href="#local-6989586621679571656"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-228"></a><span>  </span><a name="local-6989586621679571673"><a href="#local-6989586621679571673"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Class.html#askQueryResult"><span class="hs-identifier hs-var">askQueryResult</span></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679571674"><a href="#local-6989586621679571674"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679571675"><a href="#local-6989586621679571675"><span class="hs-identifier">q'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Query.Base.html#runQueryT"><span class="hs-identifier hs-var">runQueryT</span></a><span> </span><a href="#local-6989586621679571656"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#zipDynWith"><span class="hs-identifier hs-var">zipDynWith</span></a><span> </span><a href="Reflex.Query.Base.html#mapQueryResult"><span class="hs-identifier hs-var">mapQueryResult</span></a><span> </span><a href="#local-6989586621679571655"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679571673"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-230"></a><span>  </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571657"><span class="hs-identifier hs-var">zipDynIncrementalWith</span></a><span> </span><a href="Reflex.Query.Base.html#mapQuery"><span class="hs-identifier hs-var">mapQuery</span></a><span> </span><a href="#local-6989586621679571655"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679571675"><span class="hs-identifier hs-var">q'</span></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679571674"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-232"></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679571657"><a href="#local-6989586621679571657"><span class="hs-identifier">zipDynIncrementalWith</span></a></a><span> </span><a name="local-6989586621679571658"><a href="#local-6989586621679571658"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621679571659"><a href="#local-6989586621679571659"><span class="hs-identifier">da</span></a></a><span> </span><a name="local-6989586621679571660"><a href="#local-6989586621679571660"><span class="hs-identifier">ib</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-233"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679571661"><a href="#local-6989586621679571661"><span class="hs-identifier">eab</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">align</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#updated"><span class="hs-identifier hs-var">updated</span></a><span> </span><a href="#local-6989586621679571659"><span class="hs-identifier hs-var">da</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#updatedIncremental"><span class="hs-identifier hs-var">updatedIncremental</span></a><span> </span><a href="#local-6989586621679571660"><span class="hs-identifier hs-var">ib</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>             </span><a name="local-6989586621679571662"><a href="#local-6989586621679571662"><span class="hs-identifier">ec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Reflex.Class.html#push"><span class="hs-identifier hs-var">push</span></a><span> </span><a href="#local-6989586621679571661"><span class="hs-identifier hs-var">eab</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679571663"><a href="#local-6989586621679571663"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679571663"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-235"></a><span>                 </span><span class="hs-identifier hs-var">This</span><span> </span><a name="local-6989586621679571664"><a href="#local-6989586621679571664"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-236"></a><span>                   </span><a name="local-6989586621679571665"><a href="#local-6989586621679571665"><span class="hs-identifier">aOld</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#current"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679571659"><span class="hs-identifier hs-var">da</span></a><span>
</span><a name="line-237"></a><span>                   </span><a name="local-6989586621679571666"><a href="#local-6989586621679571666"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571660"><span class="hs-identifier hs-var">ib</span></a><span>
</span><a name="line-238"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571664"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679571666"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Reflex.Patch.html#~~"><span class="hs-operator hs-var">~~</span></a><span> </span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571665"><span class="hs-identifier hs-var">aOld</span></a><span> </span><a href="#local-6989586621679571666"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>                 </span><span class="hs-identifier hs-var">That</span><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><a name="local-6989586621679571667"><a href="#local-6989586621679571667"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-240"></a><span>                   </span><a name="local-6989586621679571668"><a href="#local-6989586621679571668"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#current"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679571659"><span class="hs-identifier hs-var">da</span></a><span>
</span><a name="line-241"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571668"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679571667"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-242"></a><span>                 </span><span class="hs-identifier hs-var">These</span><span> </span><a name="local-6989586621679571669"><a href="#local-6989586621679571669"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">(</span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><a name="local-6989586621679571670"><a href="#local-6989586621679571670"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-243"></a><span>                   </span><a name="local-6989586621679571671"><a href="#local-6989586621679571671"><span class="hs-identifier">aOld</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#current"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679571659"><span class="hs-identifier hs-var">da</span></a><span>
</span><a name="line-244"></a><span>                   </span><a name="local-6989586621679571672"><a href="#local-6989586621679571672"><span class="hs-identifier">bOld</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571660"><span class="hs-identifier hs-var">ib</span></a><span>
</span><a name="line-245"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Patch.html#AdditivePatch"><span class="hs-identifier hs-var">AdditivePatch</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571669"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679571672"><span class="hs-identifier hs-var">bOld</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#negateG"><span class="hs-identifier hs-var">negateG</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571671"><span class="hs-identifier hs-var">aOld</span></a><span> </span><a href="#local-6989586621679571672"><span class="hs-identifier hs-var">bOld</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679571669"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679571670"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-246"></a><span>         </span><span class="hs-keyword">in</span><span> </span><a href="Reflex.Class.html#unsafeBuildIncremental"><span class="hs-identifier hs-var">unsafeBuildIncremental</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679571658"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#current"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679571659"><span class="hs-identifier hs-var">da</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Reflex.Class.html#sample"><span class="hs-identifier hs-var">sample</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571660"><span class="hs-identifier hs-var">ib</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571662"><span class="hs-identifier hs-var">ec</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679571684"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><a href="#local-6989586621679571685"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Patch.html#Additive"><span class="hs-identifier hs-type">Additive</span></a><span> </span><a href="#local-6989586621679571685"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Query.Class.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><a href="#local-6989586621679571685"><span class="hs-identifier hs-type">q</span></a><span class="hs-special">,</span><span> </span><a href="Reflex.Class.html#Reflex"><span class="hs-identifier hs-type">Reflex</span></a><span> </span><a href="#local-6989586621679571686"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Query.Class.html#MonadQuery"><span class="hs-identifier hs-type">MonadQuery</span></a><span> </span><a href="#local-6989586621679571686"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571685"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571686"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571685"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571684"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-249"></a><span>  </span><a name="local-8214565720324231349"><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier">tellQueryIncremental</span></a></a><span> </span><a name="local-6989586621679571687"><a href="#local-6989586621679571687"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-250"></a><span>    </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#currentIncremental"><span class="hs-identifier hs-var">currentIncremental</span></a><span> </span><a href="#local-6989586621679571687"><span class="hs-identifier hs-var">q</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>    </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">(</span><a href="Reflex.EventWriter.html#tellEvent"><span class="hs-identifier hs-var">tellEvent</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#fmapCheap"><span class="hs-identifier hs-var">fmapCheap</span></a><span> </span><span class="hs-identifier">unAdditivePatch</span><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#updatedIncremental"><span class="hs-identifier hs-var">updatedIncremental</span></a><span> </span><a href="#local-6989586621679571687"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>  </span><a name="local-8214565720324231350"><a href="Reflex.Query.Class.html#askQueryResult"><span class="hs-identifier">askQueryResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-253"></a><span>  </span><a name="local-8214565720324231351"><a href="Reflex.Query.Class.html#queryIncremental"><span class="hs-identifier">queryIncremental</span></a></a><span> </span><a name="local-6989586621679571688"><a href="#local-6989586621679571688"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-254"></a><span>    </span><a href="Reflex.Query.Class.html#tellQueryIncremental"><span class="hs-identifier hs-var">tellQueryIncremental</span></a><span> </span><a href="#local-6989586621679571688"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-255"></a><span>    </span><a name="local-6989586621679571689"><a href="#local-6989586621679571689"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reflex.Query.Class.html#askQueryResult"><span class="hs-identifier hs-var">askQueryResult</span></a><span>
</span><a name="line-256"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Class.html#zipDynWith"><span class="hs-identifier hs-var">zipDynWith</span></a><span> </span><a href="Reflex.Query.Class.html#crop"><span class="hs-identifier hs-var">crop</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Class.html#incrementalToDynamic"><span class="hs-identifier hs-var">incrementalToDynamic</span></a><span> </span><a href="#local-6989586621679571688"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679571689"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.Requester.Class.html#Requester"><span class="hs-identifier hs-type">Requester</span></a><span> </span><a href="#local-6989586621679571680"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.Requester.Class.html#Requester"><span class="hs-identifier hs-type">Requester</span></a><span> </span><a href="#local-6989586621679571680"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571680"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571682"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Request</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571680"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571682"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Requester.Class.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Response</span><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571680"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571682"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Requester.Class.html#Response"><span class="hs-identifier hs-type">Response</span></a><span> </span><a href="#local-6989586621679571681"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-261"></a><span>  </span><a name="local-8214565720324247990"><a href="Reflex.Requester.Class.html#withRequesting"><span class="hs-identifier">withRequesting</span></a></a><span> </span><a name="local-6989586621679571683"><a href="#local-6989586621679571683"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-var">QueryT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reflex.Requester.Class.html#withRequesting"><span class="hs-identifier hs-var">withRequesting</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unQueryT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679571683"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-keyword">instance</span><span> </span><a href="Reflex.EventWriter.html#EventWriter"><span class="hs-identifier hs-type">EventWriter</span></a><span> </span><a href="#local-6989586621679571676"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571677"><span class="hs-identifier hs-type">w</span></a><span> </span><a href="#local-6989586621679571678"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reflex.EventWriter.html#EventWriter"><span class="hs-identifier hs-type">EventWriter</span></a><span> </span><a href="#local-6989586621679571676"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571677"><span class="hs-identifier hs-type">w</span></a><span> </span><span class="hs-special">(</span><a href="Reflex.Query.Base.html#QueryT"><span class="hs-identifier hs-type">QueryT</span></a><span> </span><a href="#local-6989586621679571676"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679571679"><span class="hs-identifier hs-type">q</span></a><span> </span><a href="#local-6989586621679571678"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>  </span><a name="local-8214565720324288574"><a href="Reflex.EventWriter.html#tellEvent"><span class="hs-identifier">tellEvent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reflex.EventWriter.html#tellEvent"><span class="hs-identifier hs-var">tellEvent</span></a><span>
</span><a name="line-265"></a></pre></body></html>